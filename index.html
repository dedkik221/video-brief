<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Умный бриф -> ТЗ на корпоративный ролик</title>
<style>
:root{
  --bg:#f5f5f7;
  --card:#ffffff;
  --text:#1d1d1f;
  --muted:#6e6e73;
  --line:#e5e5ea;
  --accent:#0071e3;
  --accentSoft:#eef6ff;
  --ok:#1f8f4c;
  --warn:#a35b00;
  --error:#b00020;
  --errorSoft:#fff3f5;
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
  color:var(--text);
  background:var(--bg);
  line-height:1.45;
}
.wrap{max-width:880px;margin:0 auto;padding:20px 16px 84px}
.top{
  position:sticky;top:0;z-index:20;
  background:rgba(245,245,247,.92);
  backdrop-filter:saturate(180%) blur(10px);
  border-bottom:1px solid var(--line);
  margin:0 -16px 18px;
  padding:14px 16px;
}
.top h1{margin:0;font-size:24px}
.top p{margin:6px 0 0;color:var(--muted);font-size:14px}
.topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:13px;color:var(--muted)}
.badge.ok{color:var(--ok);border-color:#caecd8;background:#f4fff8}
.section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:16px}
.sectionHead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.section h2{margin:0;font-size:20px}
.help{margin:0 0 10px;color:var(--muted);font-size:14px}
.status{font-size:12px;padding:5px 9px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:#fafafa}
.status.ok{color:var(--ok);border-color:#caecd8;background:#f4fff8}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:760px){.grid{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:6px}
.field.wide{grid-column:1 / -1}
label{font-size:13px;color:var(--muted)}
.req{color:var(--error)}
input[type="text"],input[type="url"],input[type="date"],input[type="number"],textarea,select{
  width:100%;
  min-height:48px;
  border:1px solid var(--line);
  border-radius:11px;
  padding:11px 12px;
  background:#fff;
  color:var(--text);
  font:inherit;
  outline:none;
}
textarea{min-height:92px;resize:vertical}
input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,113,227,.12)}
.cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:760px){.cards{grid-template-columns:1fr}}
.cardChoice{position:relative;border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff;cursor:pointer;transition:.15s ease}
.cardChoice:hover{border-color:#cfd3d7}
.cardChoice.selected{border-color:var(--accent);background:var(--accentSoft);box-shadow:0 0 0 2px rgba(0,113,227,.1) inset}
.cardChoice input{position:absolute;opacity:0;pointer-events:none}
.cardChoice h3{margin:0 0 6px;font-size:15px;color:var(--text)}
.cardChoice p{margin:0;font-size:13px;color:var(--muted)}
.checks{display:grid;gap:7px}
.check{display:flex;gap:8px;align-items:flex-start;font-size:14px;color:var(--text)}
.check input{margin-top:2px}
.inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.inline input[type="text"],.inline input[type="number"]{flex:1;min-width:160px}
.chips{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border:1px dashed var(--line);border-radius:11px;background:#fafafa;min-height:52px}
.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:13px}
.chip button{border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:14px;line-height:1}
.branch{display:none;margin-top:12px;padding-top:10px;border-top:1px solid var(--line)}
.branch.show{display:block}
.branch h3{margin:0 0 10px;font-size:15px}
.msg{display:none;border-radius:10px;padding:10px 11px;font-size:13px;margin-top:8px}
.msg.show{display:block}
.msg.error{color:var(--error);border:1px solid #f0c5cf;background:var(--errorSoft)}
.msg.warn{color:var(--warn);border:1px solid #f2d7ba;background:#fffaf5}
.small{font-size:12px;color:var(--muted)}
.actions{position:sticky;bottom:0;z-index:20;background:rgba(245,245,247,.94);backdrop-filter:saturate(180%) blur(8px);border-top:1px solid var(--line);margin:0 -16px;padding:12px 16px}
.actionRow{max-width:880px;margin:0 auto;display:flex;gap:8px;flex-wrap:wrap}
button{border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;font:inherit}
button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
button:disabled{opacity:.45;cursor:not-allowed}
button.danger{border-color:#f0c5cf;color:var(--error);background:#fff8f9}
.footerToggle{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.toast{position:fixed;left:50%;bottom:76px;transform:translateX(-50%);background:#111;color:#fff;padding:9px 12px;border-radius:999px;font-size:13px;display:none;z-index:30}
.toast.show{display:block}
.hidden{display:none}
.dialogBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:40;padding:16px}
.dialogBack.show{display:flex}
.dialog{width:min(860px,100%);max-height:88vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.2);padding:16px}
.dialog h3{margin:0 0 10px}
.preview{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12.5px;line-height:1.5;border:1px solid var(--line);border-radius:10px;padding:12px;background:#fafafa}
</style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <h1>Умный бриф для корпоративного ролика</h1>
    <p>Заполните форму один раз и получите структурированное ТЗ для команды.</p>
    <div class="topbar">
      <span class="badge" id="progressBadge">Заполнено 0 / 9 ключевых пунктов</span>
      <span class="badge" id="requiredBadge">Не хватает обязательных полей</span>
    </div>
  </header>

  <div class="section hidden" id="globalIssues">
    <div class="msg error show" id="globalMissing"></div>
    <div class="msg warn" id="globalFlags"></div>
  </div>

  <section class="section" id="secType">
    <div class="sectionHead">
      <h2>Тип ролика</h2>
      <span class="status" id="statusType">Не заполнено</span>
    </div>
    <p class="help">Выберите один тип ролика. Для второго типа лучше сделать отдельное ТЗ.</p>

    <div class="cards" id="typeCards">
      <label class="cardChoice" data-value="recap"><input type="radio" name="videoType" /><h3>Отчётный ролик (highlight / recap)</h3><p>Обычно 60-90 секунд.</p></label>
      <label class="cardChoice" data-value="process"><input type="radio" name="videoType" /><h3>Производство / процессы / люди</h3><p>Имидж компании и доверие.</p></label>
      <label class="cardChoice" data-value="thematic"><input type="radio" name="videoType" /><h3>Тематический контент</h3><p>Интервью, выступления, лекции.</p></label>
      <label class="cardChoice" data-value="ad"><input type="radio" name="videoType" /><h3>Реклама продукта</h3><p>Короткое рекламное сообщение.</p></label>
      <label class="cardChoice" data-value="vertical"><input type="radio" name="videoType" /><h3>Вертикальный контент (Reels / Shorts)</h3><p>Короткие форматы для соцсетей.</p></label>
      <label class="cardChoice" data-value="custom"><input type="radio" name="videoType" /><h3>Нестандартный заказ</h3><p>Особый сценарий вне стандартных рамок.</p></label>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="field">
        <label for="durationPreset">Хронометраж <span class="req">*</span></label>
        <select id="durationPreset">
          <option value="">Выберите</option>
          <option value="30">30 сек</option>
          <option value="60">60 сек</option>
          <option value="90">90 сек</option>
          <option value="custom">Свой хронометраж</option>
        </select>
      </div>
      <div class="field" id="durationCustomWrap" style="display:none">
        <label for="durationCustom">Свой хронометраж (сек)</label>
        <input id="durationCustom" type="number" min="1" max="1800" placeholder="Например, 75" />
      </div>
      <div class="field wide">
        <label for="durationComment">Комментарий по длительности</label>
        <textarea id="durationComment" placeholder="Если нужен длинный формат, коротко объясните зачем"></textarea>
      </div>
      <div class="field wide">
        <label>Форматы выдачи (deliverables)</label>
        <div class="checks">
          <label class="check"><input type="checkbox" class="deliverable" value="Горизонтальный (16:9)" /> Горизонтальный (16:9)</label>
          <label class="check"><input type="checkbox" class="deliverable" value="Вертикальный (9:16)" /> Вертикальный (9:16)</label>
          <label class="check"><input type="checkbox" class="deliverable" value="Квадратный (1:1)" /> Квадратный (1:1)</label>
          <label class="check"><input type="checkbox" id="deliverableCustomToggle" /> Свой вариант</label>
        </div>
        <input id="deliverableCustom" type="text" placeholder="Напишите свой формат" style="margin-top:8px;display:none" />
      </div>
    </div>

    <div class="msg error" id="flagRecapDuration"></div>
    <div class="msg warn" id="flagNoDeliverables"></div>
  </section>

  <section class="section" id="secCore">
    <div class="sectionHead">
      <h2>Минимум для старта</h2>
      <span class="status" id="statusCore">Не заполнено</span>
    </div>
    <div class="grid">
      <div class="field wide">
        <label for="mainIdea">Ключевая мысль ролика <span class="req">*</span></label>
        <textarea id="mainIdea" placeholder="После ролика человек должен понять, что..."></textarea>
      </div>
      <div class="field">
        <label>Площадки публикации <span class="req">*</span></label>
        <div class="checks">
          <label class="check"><input type="checkbox" class="platform" value="Сайт компании" /> Сайт компании</label>
          <label class="check"><input type="checkbox" class="platform" value="Внутренний портал" /> Внутренний портал</label>
          <label class="check"><input type="checkbox" class="platform" value="YouTube" /> YouTube</label>
          <label class="check"><input type="checkbox" id="platformCustomToggle" /> Свой вариант</label>
        </div>
        <input id="platformCustom" type="text" placeholder="Напишите свою площадку" style="margin-top:8px;display:none" />
      </div>

      <div class="field">
        <label>ЛПР по правкам (лицо, принимающее решение) <span class="req">*</span></label>
        <input id="lprName" type="text" placeholder="ФИО" />
        <div class="inline">
          <select id="lprContactType">
            <option value="">Тип контакта</option>
            <option value="Телефон">Телефон</option>
            <option value="Telegram">Telegram</option>
            <option value="Почта">Почта</option>
          </select>
          <input id="lprContact" type="text" placeholder="Контакт" />
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="secContent">
    <div class="sectionHead">
      <h2>Содержание</h2>
      <span class="status" id="statusContent">Не заполнено</span>
    </div>

    <div class="grid">
      <div class="field">
        <label for="goal">Цель ролика</label>
        <select id="goal">
          <option value="">Выберите</option>
          <option>Показать атмосферу / эмоции</option>
          <option>Привлечь на следующее мероприятие</option>
          <option>Внутренний отчёт руководству</option>
          <option>Имидж: усилить доверие</option>
          <option>Объяснить тему / решение</option>
          <option>Продвигать продукт / услугу</option>
          <option>Другое</option>
        </select>
      </div>
      <div class="field">
        <label for="cta">Что зритель должен сделать дальше</label>
        <input id="cta" type="text" placeholder="Что зритель должен сделать дальше" />
      </div>
      <div class="field wide">
        <label for="targetAudience">Целевая аудитория ролика</label>
        <textarea id="targetAudience" placeholder="Опишите, на кого ориентирован ролик и насколько эта аудитория вовлечена в продукт или в тему."></textarea>
      </div>

      <div class="field wide">
        <label>Ключевые мысли ролика (3-5 пунктов)</label>
        <p class="small">Что это: короткие смысловые пункты, которые обязательно должны остаться в финальном монтаже. Пример: 1) Какую проблему решаем 2) В чем отличие 3) Какой результат получает клиент.</p>
        <div class="inline">
          <input id="thesisInput" type="text" placeholder="Один тезис = одна короткая мысль" />
          <button type="button" id="thesisAdd">Добавить мысль</button>
        </div>
        <div class="chips" id="thesisChips"></div>
        <div class="msg warn" id="flagTooManyTheses"></div>
      </div>
    </div>

    <div class="branch" data-branch="recap">
      <h3>Детализация для отчётного ролика</h3>
      <div class="grid">
        <div class="field"><label for="recapMoments">3 главных момента</label><textarea id="recapMoments"></textarea></div>
        <div class="field"><label for="recapSync">Нужны синхроны</label><select id="recapSync"><option value="">Выберите</option><option>Да</option><option>Нет</option></select></div>
        <div class="field wide"><label for="recapStructure">Структура</label><textarea id="recapStructure">hook 0-10с -> нарастание 10-30с -> пик 30-60с -> финал/лого/CTA</textarea></div>
      </div>
    </div>

    <div class="branch" data-branch="process">
      <h3>Детализация для производства / процессов / людей</h3>
      <div class="grid">
        <div class="field"><label for="processShow">Что показать</label><input id="processShow" type="text" placeholder="Люди, процессы, качество, масштаб" /></div>
        <div class="field"><label for="processAudio">Звук/речь</label><input id="processAudio" type="text" placeholder="Интервью, диктор, атмосферный звук" /></div>
        <div class="field wide"><label for="processNoShoot">Что нельзя снимать</label><textarea id="processNoShoot"></textarea></div>
      </div>
    </div>

    <div class="branch" data-branch="thematic">
      <h3>Детализация для тематического контента</h3>
      <div class="grid">
        <div class="field"><label for="thematicFormat">Тип сборки</label><select id="thematicFormat"><option value="">Выберите</option><option>Полная версия</option><option>Нарезка/дайджест</option></select></div>
        <div class="field"><label for="thematicCut">Что вырезать</label><textarea id="thematicCut"></textarea></div>
      </div>
    </div>

    <div class="branch" data-branch="ad">
      <h3>Детализация для рекламы продукта</h3>
      <div class="grid">
        <div class="field wide"><label for="adOneLiner">Один главный посыл</label><input id="adOneLiner" type="text" /></div>
        <div class="field"><label for="adLegal">Что можно обещать юридически</label><textarea id="adLegal"></textarea></div>
        <div class="field"><label for="adAI">Допустимость AI</label><select id="adAI"><option value="">Выберите</option><option>Да</option><option>Нет</option><option>Только вспомогательно</option></select></div>
      </div>
    </div>

    <div class="branch" data-branch="vertical">
      <h3>Детализация для вертикального контента</h3>
      <div class="grid">
        <div class="field"><label for="verticalHook">Короткий hook (первые 1-2 секунды)</label><input id="verticalHook" type="text" /></div>
        <div class="field"><label for="verticalMessage">Короткий посыл</label><input id="verticalMessage" type="text" /></div>
        <div class="field wide"><label for="verticalAction">Что конкретно делаем в ролике</label><textarea id="verticalAction"></textarea></div>
      </div>
    </div>

    <div class="branch" data-branch="custom">
      <h3>Детализация для нестандартного заказа</h3>
      <div class="grid">
        <div class="field"><label for="customType">Кратко: какой это формат</label><input id="customType" type="text" /></div>
        <div class="field"><label for="customResult">Какой ожидается результат</label><input id="customResult" type="text" /></div>
        <div class="field wide"><label for="customLimits">Особые ограничения/условия</label><textarea id="customLimits"></textarea></div>
      </div>
    </div>
  </section>

  <section class="section" id="secMaterials">
    <div class="sectionHead">
      <h2>Материалы и ограничения</h2>
      <span class="status" id="statusMaterials">Не заполнено</span>
    </div>
    <div class="grid">
      <div class="field wide"><label for="sourceLinks">Ссылки на исходники</label><textarea id="sourceLinks"></textarea></div>
      <div class="field wide"><label for="needShoot">Что нужно снять</label><textarea id="needShoot"></textarea></div>
      <div class="field wide"><label for="mustTitles">Обязательные титры/логотипы</label><textarea id="mustTitles"></textarea></div>
      <div class="field wide"><label for="constraints">Ограничения (NDA, запреты)</label><textarea id="constraints"></textarea></div>
    </div>
  </section>

  <section class="section" id="secTiming">
    <div class="sectionHead">
      <h2>Сроки</h2>
      <span class="status" id="statusTiming">Не заполнено</span>
    </div>
    <div class="grid">
      <div class="field"><label for="eventDate">Дата события</label><input id="eventDate" type="date" /></div>
      <div class="field"><label for="draftDate">Черновик</label><input id="draftDate" type="date" /></div>
      <div class="field"><label for="finalDate">Финал</label><input id="finalDate" type="date" /></div>
      <div class="field"><label for="prodDate">Передача в продакшен</label><input id="prodDate" type="date" /></div>
      <div class="field wide"><label for="timingNotes">Комментарий по срокам</label><textarea id="timingNotes"></textarea></div>
    </div>
  </section>

  <section class="section">
    <div class="footerToggle">
      <div>
        <strong>Запомнить на этом компьютере</strong>
        <p class="small" style="margin:4px 0 0">Сохраняет заполненные поля в браузере (LocalStorage).</p>
      </div>
      <label><input id="remember" type="checkbox" /> Включено</label>
    </div>
  </section>
</div>

<div class="actions">
  <div class="actionRow">
    <button id="btnGenerate" class="primary" disabled>Сформировать ТЗ</button>
    <button id="btnPreview" disabled>Предпросмотр</button>
    <button id="btnCopy" disabled>Копировать</button>
    <button id="btnTxt" disabled>Скачать .txt</button>
    <button id="btnPdf" disabled>Скачать PDF (A4)</button>
    <button id="btnReset" class="danger">Сбросить</button>
  </div>
</div>

<div class="dialogBack" id="previewBack">
  <div class="dialog">
    <h3>Предпросмотр ТЗ</h3>
    <div class="preview" id="previewText"></div>
    <div class="actionRow" style="margin-top:10px">
      <button id="dialogCopy">Копировать</button>
      <button id="dialogClose">Закрыть</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  const LS_KEY = "smartBrief_v3_min";
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  const ui = {
    progressBadge: $("#progressBadge"),
    requiredBadge: $("#requiredBadge"),
    globalIssues: $("#globalIssues"),
    globalMissing: $("#globalMissing"),
    globalFlags: $("#globalFlags"),

    typeCards: $("#typeCards"),
    durationPreset: $("#durationPreset"),
    durationCustomWrap: $("#durationCustomWrap"),
    durationCustom: $("#durationCustom"),
    durationComment: $("#durationComment"),
    deliverables: $$(".deliverable"),
    deliverableCustomToggle: $("#deliverableCustomToggle"),
    deliverableCustom: $("#deliverableCustom"),

    mainIdea: $("#mainIdea"),
    platforms: $$(".platform"),
    platformCustomToggle: $("#platformCustomToggle"),
    platformCustom: $("#platformCustom"),
    lprName: $("#lprName"),
    lprContactType: $("#lprContactType"),
    lprContact: $("#lprContact"),

    goal: $("#goal"),
    cta: $("#cta"),
    targetAudience: $("#targetAudience"),
    thesisInput: $("#thesisInput"),
    thesisAdd: $("#thesisAdd"),
    thesisChips: $("#thesisChips"),

    recapMoments: $("#recapMoments"), recapSync: $("#recapSync"), recapStructure: $("#recapStructure"),
    processShow: $("#processShow"), processAudio: $("#processAudio"), processNoShoot: $("#processNoShoot"),
    thematicFormat: $("#thematicFormat"), thematicCut: $("#thematicCut"),
    adOneLiner: $("#adOneLiner"), adLegal: $("#adLegal"), adAI: $("#adAI"),
    verticalHook: $("#verticalHook"), verticalMessage: $("#verticalMessage"), verticalAction: $("#verticalAction"),
    customType: $("#customType"), customResult: $("#customResult"), customLimits: $("#customLimits"),

    sourceLinks: $("#sourceLinks"), needShoot: $("#needShoot"), mustTitles: $("#mustTitles"), constraints: $("#constraints"),
    eventDate: $("#eventDate"), draftDate: $("#draftDate"), finalDate: $("#finalDate"), prodDate: $("#prodDate"), timingNotes: $("#timingNotes"),

    remember: $("#remember"),

    btnGenerate: $("#btnGenerate"), btnPreview: $("#btnPreview"), btnCopy: $("#btnCopy"), btnTxt: $("#btnTxt"), btnPdf: $("#btnPdf"), btnReset: $("#btnReset"),
    previewBack: $("#previewBack"), previewText: $("#previewText"), dialogCopy: $("#dialogCopy"), dialogClose: $("#dialogClose"),

    flagRecapDuration: $("#flagRecapDuration"), flagNoDeliverables: $("#flagNoDeliverables"), flagTooManyTheses: $("#flagTooManyTheses"),

    statusType: $("#statusType"), statusCore: $("#statusCore"), statusContent: $("#statusContent"), statusMaterials: $("#statusMaterials"), statusTiming: $("#statusTiming"),
    toast: $("#toast")
  };

  const state = {
    remember:false,
    type:"",
    durationPreset:"",
    durationCustom:"",
    durationComment:"",
    deliverables:[],
    deliverableCustom:"",

    mainIdea:"",
    platforms:[],
    platformCustom:"",
    lprName:"",
    lprContactType:"",
    lprContact:"",

    goal:"",
    cta:"",
    targetAudience:"",
    theses:[],

    recap:{moments:"",sync:"",structure:"hook 0-10с -> нарастание 10-30с -> пик 30-60с -> финал/лого/CTA"},
    process:{show:"",audio:"",noShoot:""},
    thematic:{format:"",cut:""},
    ad:{oneLiner:"",legal:"",ai:""},
    vertical:{hook:"",message:"",action:""},
    custom:{type:"",result:"",limits:""},

    sourceLinks:"",
    needShoot:"",
    mustTitles:"",
    constraints:"",

    eventDate:"",
    draftDate:"",
    finalDate:"",
    prodDate:"",
    timingNotes:"",

    generated:""
  };

  function toast(text){
    ui.toast.textContent = text;
    ui.toast.classList.add("show");
    clearTimeout(toast.t);
    toast.t = setTimeout(() => ui.toast.classList.remove("show"), 1700);
  }

  function durationSec(){
    if(state.durationPreset === "custom"){
      const n = Number(state.durationCustom || 0);
      return n > 0 ? n : 0;
    }
    return Number(state.durationPreset || 0);
  }

  function requiredMissing(){
    const m = [];
    if(!state.type) m.push("Тип ролика");
    if(!durationSec()) m.push("Хронометраж");
    if(!state.mainIdea.trim()) m.push("Ключевая мысль ролика");
    if(!state.platforms.length && !state.platformCustom.trim()) m.push("Площадки публикации");
    if(!state.lprName.trim()) m.push("ЛПР: ФИО");
    if(!state.lprContactType) m.push("ЛПР: тип контакта");
    if(!state.lprContact.trim()) m.push("ЛПР: контакт");
    return m;
  }

  function findFlags(){
    const f = [];
    if(state.type === "recap"){
      const sec = durationSec();
      const comment = state.durationComment.toLowerCase();
      if((sec && sec > 120) || /5\s*мин|пять\s*мин|5\s*минут|300/.test(comment)){
        f.push("Это уже не highlight: либо hero 2-3 минуты/док-формат, либо сокращаем до 60-90 секунд.");
      }
    }
    if(state.theses.length > 5){
      f.push("Ключевых мыслей больше 5: сообщение размывается. Оставьте 3-5 пунктов.");
    }
    if(state.type && !state.deliverables.length && !state.deliverableCustom.trim()){
      f.push("Не выбраны форматы выдачи: добавьте хотя бы один формат.");
    }
    return f;
  }

  function typeLabel(){
    const map = {
      recap:"Отчётный ролик (highlight/recap)",
      process:"Производство / процессы / люди",
      thematic:"Тематический контент",
      ad:"Реклама продукта",
      vertical:"Вертикальный контент (Reels/Shorts)",
      custom:"Нестандартный заказ"
    };
    return map[state.type] || "-";
  }

  function status(el, done, partial){
    el.className = "status" + (done ? " ok" : "");
    el.textContent = done ? "Готово" : (partial ? "Частично" : "Не заполнено");
  }

  function updateTypeUI(){
    $$(".cardChoice", ui.typeCards).forEach(card => {
      const on = card.dataset.value === state.type;
      card.classList.toggle("selected", on);
      const r = $("input", card);
      if(r) r.checked = on;
    });
    $$(".branch").forEach(b => b.classList.toggle("show", b.dataset.branch === state.type));
  }

  function updateToggles(){
    ui.durationCustomWrap.style.display = state.durationPreset === "custom" ? "block" : "none";
    ui.platformCustom.style.display = ui.platformCustomToggle.checked ? "block" : "none";
    ui.deliverableCustom.style.display = ui.deliverableCustomToggle.checked ? "block" : "none";
  }

  function renderTheses(){
    ui.thesisChips.innerHTML = "";
    if(!state.theses.length){
      ui.thesisChips.innerHTML = '<span class="small">Пока пусто. Добавьте 3-5 смысловых пунктов.</span>';
      return;
    }
    state.theses.forEach((t, i) => {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `<span>${escapeHtml(t)}</span><button type="button">x</button>`;
      $("button", chip).addEventListener("click", () => {
        state.theses.splice(i,1);
        renderTheses();
        runChecks();
        saveLS();
      });
      ui.thesisChips.appendChild(chip);
    });
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function syncFromUI(){
    state.remember = ui.remember.checked;
    state.durationPreset = ui.durationPreset.value;
    state.durationCustom = ui.durationCustom.value;
    state.durationComment = ui.durationComment.value;
    state.deliverables = ui.deliverables.filter(c => c.checked).map(c => c.value);
    state.deliverableCustom = ui.deliverableCustomToggle.checked ? ui.deliverableCustom.value : "";

    state.mainIdea = ui.mainIdea.value;
    state.platforms = ui.platforms.filter(c => c.checked).map(c => c.value);
    state.platformCustom = ui.platformCustomToggle.checked ? ui.platformCustom.value : "";
    state.lprName = ui.lprName.value;
    state.lprContactType = ui.lprContactType.value;
    state.lprContact = ui.lprContact.value;

    state.goal = ui.goal.value;
    state.cta = ui.cta.value;
    state.targetAudience = ui.targetAudience.value;

    state.recap.moments = ui.recapMoments.value;
    state.recap.sync = ui.recapSync.value;
    state.recap.structure = ui.recapStructure.value;

    state.process.show = ui.processShow.value;
    state.process.audio = ui.processAudio.value;
    state.process.noShoot = ui.processNoShoot.value;

    state.thematic.format = ui.thematicFormat.value;
    state.thematic.cut = ui.thematicCut.value;

    state.ad.oneLiner = ui.adOneLiner.value;
    state.ad.legal = ui.adLegal.value;
    state.ad.ai = ui.adAI.value;

    state.vertical.hook = ui.verticalHook.value;
    state.vertical.message = ui.verticalMessage.value;
    state.vertical.action = ui.verticalAction.value;

    state.custom.type = ui.customType.value;
    state.custom.result = ui.customResult.value;
    state.custom.limits = ui.customLimits.value;

    state.sourceLinks = ui.sourceLinks.value;
    state.needShoot = ui.needShoot.value;
    state.mustTitles = ui.mustTitles.value;
    state.constraints = ui.constraints.value;

    state.eventDate = ui.eventDate.value;
    state.draftDate = ui.draftDate.value;
    state.finalDate = ui.finalDate.value;
    state.prodDate = ui.prodDate.value;
    state.timingNotes = ui.timingNotes.value;
  }

  function syncToUI(){
    ui.remember.checked = !!state.remember;

    ui.durationPreset.value = state.durationPreset;
    ui.durationCustom.value = state.durationCustom;
    ui.durationComment.value = state.durationComment;
    ui.deliverables.forEach(c => c.checked = state.deliverables.includes(c.value));
    ui.deliverableCustomToggle.checked = !!state.deliverableCustom;
    ui.deliverableCustom.value = state.deliverableCustom;

    ui.mainIdea.value = state.mainIdea;
    ui.platforms.forEach(c => c.checked = state.platforms.includes(c.value));
    ui.platformCustomToggle.checked = !!state.platformCustom;
    ui.platformCustom.value = state.platformCustom;
    ui.lprName.value = state.lprName;
    ui.lprContactType.value = state.lprContactType;
    ui.lprContact.value = state.lprContact;

    ui.goal.value = state.goal;
    ui.cta.value = state.cta;
    ui.targetAudience.value = state.targetAudience;

    ui.recapMoments.value = state.recap.moments;
    ui.recapSync.value = state.recap.sync;
    ui.recapStructure.value = state.recap.structure;

    ui.processShow.value = state.process.show;
    ui.processAudio.value = state.process.audio;
    ui.processNoShoot.value = state.process.noShoot;

    ui.thematicFormat.value = state.thematic.format;
    ui.thematicCut.value = state.thematic.cut;

    ui.adOneLiner.value = state.ad.oneLiner;
    ui.adLegal.value = state.ad.legal;
    ui.adAI.value = state.ad.ai;

    ui.verticalHook.value = state.vertical.hook;
    ui.verticalMessage.value = state.vertical.message;
    ui.verticalAction.value = state.vertical.action;

    ui.customType.value = state.custom.type;
    ui.customResult.value = state.custom.result;
    ui.customLimits.value = state.custom.limits;

    ui.sourceLinks.value = state.sourceLinks;
    ui.needShoot.value = state.needShoot;
    ui.mustTitles.value = state.mustTitles;
    ui.constraints.value = state.constraints;

    ui.eventDate.value = state.eventDate;
    ui.draftDate.value = state.draftDate;
    ui.finalDate.value = state.finalDate;
    ui.prodDate.value = state.prodDate;
    ui.timingNotes.value = state.timingNotes;

    updateTypeUI();
    updateToggles();
    renderTheses();
  }

  function saveLS(){
    if(!state.remember) return;
    try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(_e){}
  }

  function loadLS(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return false;
      const data = JSON.parse(raw);
      if(!data || typeof data !== "object") return false;
      for(const k of Object.keys(state)){
        if(k in data) state[k] = data[k];
      }
      return true;
    }catch(_e){ return false; }
  }

  function clearLS(){
    try{ localStorage.removeItem(LS_KEY); }catch(_e){}
  }

  function durationLabel(){
    const sec = durationSec();
    return sec ? `${sec} сек` : "-";
  }

  function platformList(){
    const list = [...state.platforms];
    if(state.platformCustom.trim()) list.push(state.platformCustom.trim());
    return list;
  }

  function deliverableList(){
    const list = [...state.deliverables];
    if(state.deliverableCustom.trim()) list.push(state.deliverableCustom.trim());
    return list;
  }

  function buildTZ(){
    const miss = requiredMissing();
    const flags = findFlags();
    const lines = [];

    lines.push("ТЕХНИЧЕСКОЕ ЗАДАНИЕ (черновик)");
    lines.push("=".repeat(42));
    lines.push("");

    if(miss.length){
      lines.push("НЕ ХВАТАЕТ ДАННЫХ:");
      miss.forEach(m => lines.push(`- ${m}`));
      lines.push("");
    }

    if(flags.length){
      lines.push("ПРЕДУПРЕЖДЕНИЯ:");
      flags.forEach(f => lines.push(`- ${f}`));
      lines.push("");
    }

    lines.push("1. Тип ролика и хронометраж");
    lines.push(`Тип ролика: ${typeLabel()}`);
    lines.push(`Хронометраж: ${durationLabel()}`);
    lines.push(`Комментарий по длительности: ${state.durationComment.trim() || "-"}`);
    lines.push(`Форматы выдачи: ${deliverableList().join(", ") || "-"}`);
    lines.push("");

    lines.push("2. Цель, аудитория, ключевая мысль, целевое действие");
    lines.push(`Цель ролика: ${state.goal || "-"}`);
    lines.push(`Ключевая мысль: ${state.mainIdea.trim() || "-"}`);
    lines.push(`Целевая аудитория: ${state.targetAudience.trim() || "-"}`);
    lines.push(`Что зритель должен сделать дальше: ${state.cta.trim() || "-"}`);
    lines.push(`Площадки публикации: ${platformList().join(", ") || "-"}`);
    lines.push("");

    lines.push("3. Ключевые мысли ролика");
    (state.theses.length ? state.theses : ["-"]).forEach(t => lines.push(`- ${t}`));
    lines.push("");

    lines.push("4. Детализация по выбранному типу");
    if(state.type === "recap"){
      lines.push(`- Главные моменты: ${state.recap.moments.trim() || "-"}`);
      lines.push(`- Синхроны: ${state.recap.sync || "-"}`);
      lines.push(`- Структура: ${state.recap.structure.trim() || "-"}`);
    } else if(state.type === "process"){
      lines.push(`- Что показать: ${state.process.show.trim() || "-"}`);
      lines.push(`- Звук/речь: ${state.process.audio.trim() || "-"}`);
      lines.push(`- Что нельзя снимать: ${state.process.noShoot.trim() || "-"}`);
    } else if(state.type === "thematic"){
      lines.push(`- Формат: ${state.thematic.format || "-"}`);
      lines.push(`- Что вырезать: ${state.thematic.cut.trim() || "-"}`);
    } else if(state.type === "ad"){
      lines.push(`- Главный посыл: ${state.ad.oneLiner.trim() || "-"}`);
      lines.push(`- Юридические обещания: ${state.ad.legal.trim() || "-"}`);
      lines.push(`- AI: ${state.ad.ai || "-"}`);
    } else if(state.type === "vertical"){
      lines.push(`- Hook: ${state.vertical.hook.trim() || "-"}`);
      lines.push(`- Короткий посыл: ${state.vertical.message.trim() || "-"}`);
      lines.push(`- Что делаем: ${state.vertical.action.trim() || "-"}`);
    } else if(state.type === "custom"){
      lines.push(`- Формат: ${state.custom.type.trim() || "-"}`);
      lines.push(`- Ожидаемый результат: ${state.custom.result.trim() || "-"}`);
      lines.push(`- Особые ограничения: ${state.custom.limits.trim() || "-"}`);
    } else {
      lines.push("-");
    }
    lines.push("");

    lines.push("5. Материалы и ограничения");
    lines.push(`Исходники: ${state.sourceLinks.trim() || "-"}`);
    lines.push(`Что нужно снять: ${state.needShoot.trim() || "-"}`);
    lines.push(`Титры/логотипы: ${state.mustTitles.trim() || "-"}`);
    lines.push(`Ограничения: ${state.constraints.trim() || "-"}`);
    lines.push("");

    lines.push("6. Сроки");
    lines.push(`Дата события: ${state.eventDate || "-"}`);
    lines.push(`Черновик: ${state.draftDate || "-"}`);
    lines.push(`Финал: ${state.finalDate || "-"}`);
    lines.push(`Передача в продакшен: ${state.prodDate || "-"}`);
    lines.push(`Комментарий: ${state.timingNotes.trim() || "-"}`);
    lines.push("");

    lines.push("7. ЛПР по правкам");
    lines.push(`ФИО: ${state.lprName.trim() || "-"}`);
    lines.push(`Тип контакта: ${state.lprContactType || "-"}`);
    lines.push(`Контакт: ${state.lprContact.trim() || "-"}`);

    return lines.join("\n");
  }

  function buildPdfHtml(text){
    const esc = escapeHtml(text).replaceAll("\n", "<br>");
    return `<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>ТЗ</title>
<style>
@page { size: A4; margin: 12mm; }
html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;color:#111}
.sheet{width:100%;height:auto}
h1{margin:0 0 8px;font-size:16px}
.meta{font-size:11px;color:#666;margin-bottom:8px}
.body{font-size:10.5px;line-height:1.28;word-break:break-word}
</style>
</head>
<body>
<div class="sheet">
  <h1>Техническое задание</h1>
  <div class="meta">Сформировано: ${new Date().toLocaleString()}</div>
  <div class="body">${esc}</div>
</div>
</body>
</html>`;
  }

  function runChecks(){
    syncFromUI();
    updateTypeUI();
    updateToggles();

    const miss = requiredMissing();
    const flags = findFlags();

    ui.globalIssues.classList.toggle("hidden", !(miss.length || flags.length));
    ui.globalMissing.classList.toggle("show", miss.length > 0);
    ui.globalMissing.textContent = miss.length ? `Не хватает данных: ${miss.join(", ")}.` : "";
    ui.globalFlags.classList.toggle("show", flags.length > 0);
    ui.globalFlags.textContent = flags.join(" ");

    const recapFlag = flags.find(x => x.includes("highlight"));
    ui.flagRecapDuration.classList.toggle("show", !!recapFlag);
    ui.flagRecapDuration.textContent = recapFlag || "";

    const delFlag = flags.find(x => x.includes("форматы выдачи"));
    ui.flagNoDeliverables.classList.toggle("show", !!delFlag);
    ui.flagNoDeliverables.textContent = delFlag || "";

    const thesisFlag = flags.find(x => x.includes("Ключевых мыслей"));
    ui.flagTooManyTheses.classList.toggle("show", !!thesisFlag);
    ui.flagTooManyTheses.textContent = thesisFlag || "";

    const keys = [
      !!state.type,
      !!durationSec(),
      !!state.mainIdea.trim(),
      platformList().length > 0,
      !!state.lprName.trim() && !!state.lprContactType && !!state.lprContact.trim(),
      !!state.goal,
      !!state.targetAudience.trim(),
      state.theses.length >= 3,
      !!(state.sourceLinks.trim() || state.needShoot.trim() || state.constraints.trim())
    ];

    const done = keys.filter(Boolean).length;
    ui.progressBadge.textContent = `Заполнено ${done} / 9 ключевых пунктов`;
    ui.requiredBadge.textContent = miss.length ? "Не хватает обязательных полей" : "Обязательные поля заполнены";
    ui.requiredBadge.className = "badge" + (miss.length ? "" : " ok");

    status(ui.statusType, !!state.type && !!durationSec(), !!state.type || !!durationSec());
    status(ui.statusCore, !!state.mainIdea.trim() && platformList().length>0 && !!state.lprName.trim() && !!state.lprContactType && !!state.lprContact.trim(), !!state.mainIdea.trim() || platformList().length>0 || !!state.lprName.trim());
    status(ui.statusContent, !!state.goal || state.theses.length>0 || !!state.targetAudience.trim(), !!state.goal || state.theses.length>0 || !!state.targetAudience.trim());
    status(ui.statusMaterials, !!(state.sourceLinks.trim() || state.needShoot.trim() || state.constraints.trim()), !!(state.sourceLinks.trim() || state.needShoot.trim() || state.constraints.trim()));
    status(ui.statusTiming, !!(state.finalDate || state.draftDate || state.prodDate), !!(state.finalDate || state.draftDate || state.prodDate));

    ui.btnGenerate.disabled = miss.length > 0;
    const has = !!state.generated.trim();
    ui.btnPreview.disabled = !has;
    ui.btnCopy.disabled = !has;
    ui.btnTxt.disabled = !has;
    ui.btnPdf.disabled = !has;
  }

  function markDirty(){
    if(state.generated){
      state.generated = "";
      ui.previewText.textContent = "";
    }
  }

  function bind(){
    ui.typeCards.addEventListener("click", (e) => {
      const card = e.target.closest(".cardChoice");
      if(!card) return;
      state.type = card.dataset.value;
      markDirty();
      updateTypeUI();
      runChecks();
      saveLS();
    });

    ui.durationPreset.addEventListener("change", () => {
      markDirty();
      updateToggles();
      runChecks();
      saveLS();
    });

    ui.platformCustomToggle.addEventListener("change", () => {
      if(!ui.platformCustomToggle.checked) ui.platformCustom.value = "";
      markDirty();
      updateToggles();
      runChecks();
      saveLS();
    });

    ui.deliverableCustomToggle.addEventListener("change", () => {
      if(!ui.deliverableCustomToggle.checked) ui.deliverableCustom.value = "";
      markDirty();
      updateToggles();
      runChecks();
      saveLS();
    });

    const inputs = $$("input, textarea, select").filter(x => x.id !== "remember");
    inputs.forEach(el => {
      el.addEventListener("input", () => { markDirty(); runChecks(); saveLS(); });
      el.addEventListener("change", () => { markDirty(); runChecks(); saveLS(); });
    });

    ui.thesisAdd.addEventListener("click", () => {
      const t = ui.thesisInput.value.trim();
      if(!t) return;
      state.theses.push(t);
      ui.thesisInput.value = "";
      markDirty();
      renderTheses();
      runChecks();
      saveLS();
    });

    ui.thesisInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        ui.thesisAdd.click();
      }
    });

    ui.remember.addEventListener("change", () => {
      state.remember = ui.remember.checked;
      if(state.remember){
        saveLS();
        toast("Автосохранение включено");
      } else {
        clearLS();
        toast("Автосохранение выключено");
      }
    });

    ui.btnGenerate.addEventListener("click", () => {
      runChecks();
      if(ui.btnGenerate.disabled) return;
      state.generated = buildTZ();
      ui.previewText.textContent = state.generated;
      ui.btnPreview.disabled = false;
      ui.btnCopy.disabled = false;
      ui.btnTxt.disabled = false;
      ui.btnPdf.disabled = false;
      saveLS();
      toast("ТЗ сформировано");
    });

    ui.btnPreview.addEventListener("click", () => {
      if(!state.generated.trim()) return;
      ui.previewText.textContent = state.generated;
      ui.previewBack.classList.add("show");
    });

    ui.dialogClose.addEventListener("click", () => ui.previewBack.classList.remove("show"));
    ui.previewBack.addEventListener("click", (e) => {
      if(e.target === ui.previewBack) ui.previewBack.classList.remove("show");
    });

    async function copyText(txt){
      try{ await navigator.clipboard.writeText(txt); }
      catch(_e){
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
    }

    ui.btnCopy.addEventListener("click", async () => {
      if(!state.generated.trim()) return;
      await copyText(state.generated);
      toast("Скопировано");
    });

    ui.dialogCopy.addEventListener("click", async () => {
      if(!state.generated.trim()) return;
      await copyText(state.generated);
      toast("Скопировано");
    });

    ui.btnTxt.addEventListener("click", () => {
      if(!state.generated.trim()) return;
      const blob = new Blob([state.generated], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `TZ_video_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("TXT скачан");
    });

    ui.btnPdf.addEventListener("click", () => {
      if(!state.generated.trim()) return;
      const w = window.open("", "_blank");
      if(!w){
        toast("Разрешите всплывающие окна для PDF");
        return;
      }
      w.document.open();
      w.document.write(buildPdfHtml(state.generated));
      w.document.close();
      w.focus();
      setTimeout(() => w.print(), 250);
    });

    ui.btnReset.addEventListener("click", () => {
      if(!confirm("Сбросить все ответы?")) return;
      const keepRemember = state.remember;
      Object.assign(state, {
        remember:keepRemember,type:"",durationPreset:"",durationCustom:"",durationComment:"",deliverables:[],deliverableCustom:"",
        mainIdea:"",platforms:[],platformCustom:"",lprName:"",lprContactType:"",lprContact:"",
        goal:"",cta:"",targetAudience:"",theses:[],
        recap:{moments:"",sync:"",structure:"hook 0-10с -> нарастание 10-30с -> пик 30-60с -> финал/лого/CTA"},
        process:{show:"",audio:"",noShoot:""}, thematic:{format:"",cut:""}, ad:{oneLiner:"",legal:"",ai:""},
        vertical:{hook:"",message:"",action:""}, custom:{type:"",result:"",limits:""},
        sourceLinks:"",needShoot:"",mustTitles:"",constraints:"",
        eventDate:"",draftDate:"",finalDate:"",prodDate:"",timingNotes:"",
        generated:""
      });
      syncToUI();
      runChecks();
      if(!state.remember) clearLS(); else saveLS();
      toast("Сброшено");
      window.scrollTo({top:0,behavior:"smooth"});
    });
  }

  function init(){
    if(loadLS()) toast("Черновик восстановлен");
    syncToUI();
    bind();
    runChecks();
  }

  init();
})();
</script>
</body>
</html>
